---
import BaseLayout from '@/layouts/BaseLayout.astro';
import TagPill from '@/components/TagPill.astro';
import { getCollection } from 'astro:content';
import { formatDate, readingTime } from '@/utils/helpers';
import { projects, getProjectBySlug } from '@/data/projects';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => !data.draft);
  const sorted = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

  return sorted.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      post,
      prevPost: sorted[index + 1] ?? null,
      nextPost: sorted[index - 1] ?? null,
    },
  }));
}

const { post, prevPost, nextPost } = Astro.props;
const { Content } = await post.render();
const { title, description, date, tags, image, imageAlt, relatedProjects: relatedProjectSlugs } = post.data;
const rt = readingTime(post.body);

const relatedProjectList = relatedProjectSlugs
  .map((slug) => getProjectBySlug(slug))
  .filter(Boolean);
---

<BaseLayout title={title} description={description} image={image}>
  <article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-24">
    <!-- Back link -->
    <a href="/blog" class="inline-flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 hover:text-accent-600 dark:hover:text-accent-400 transition-colors mb-10">
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Blog
    </a>

    <!-- Header -->
    <header class="mb-10">
      <div class="flex flex-wrap gap-2 mb-4">
        {tags.map((tag) => <TagPill label={tag} href={`/blog?tag=${encodeURIComponent(tag)}`} small />)}
      </div>
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white leading-tight mb-4">{title}</h1>
      <p class="text-xl text-gray-600 dark:text-gray-300 mb-6">{description}</p>
      <div class="flex items-center gap-3 text-sm text-gray-500 dark:text-gray-400">
        <time datetime={date.toISOString()}>{formatDate(date)}</time>
        <span>·</span>
        <span>{rt} min read</span>
      </div>
    </header>

    <!-- Hero image -->
    {image && (
      <div class="rounded-2xl overflow-hidden mb-12 shadow-xl border border-gray-200 dark:border-gray-800">
        <img src={image} alt={imageAlt ?? title} class="w-full" />
      </div>
    )}

    <!-- Content -->
    <div class="prose dark:prose-invert prose-lg max-w-none
                prose-headings:font-bold
                prose-a:text-accent-600 dark:prose-a:text-accent-400
                prose-code:font-mono
                prose-pre:bg-gray-900 dark:prose-pre:bg-gray-950
                prose-pre:border prose-pre:border-gray-800
                prose-pre:rounded-xl
                prose-img:rounded-xl prose-img:shadow-lg">
      <Content />
    </div>

    <!-- Related Projects -->
    {relatedProjectList.length > 0 && (
      <aside class="mt-16 p-6 bg-accent-50 dark:bg-accent-950/30 border border-accent-200 dark:border-accent-800 rounded-xl">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Related Projects</h2>
        <div class="space-y-3">
          {relatedProjectList.map((project) => project && (
            <a href={`/projects/${project.slug}`}
               class="flex items-start gap-4 p-3 bg-white dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-accent-400 dark:hover:border-accent-600 transition-colors">
              <div>
                <p class="font-medium text-gray-900 dark:text-white text-sm">{project.title}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 line-clamp-1">{project.description}</p>
              </div>
              <svg class="h-4 w-4 text-gray-400 flex-shrink-0 mt-0.5 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
          ))}
        </div>
      </aside>
    )}

    <!-- Prev / Next navigation -->
    <nav class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-800 grid grid-cols-2 gap-6">
      {prevPost ? (
        <a href={`/blog/${prevPost.slug}`} class="group text-left">
          <span class="text-xs text-gray-500 dark:text-gray-400 block mb-1">← Previous</span>
          <span class="text-sm font-medium text-gray-700 dark:text-gray-200 group-hover:text-accent-600 dark:group-hover:text-accent-400 transition-colors line-clamp-2">
            {prevPost.data.title}
          </span>
        </a>
      ) : <div />}

      {nextPost ? (
        <a href={`/blog/${nextPost.slug}`} class="group text-right col-start-2">
          <span class="text-xs text-gray-500 dark:text-gray-400 block mb-1">Next →</span>
          <span class="text-sm font-medium text-gray-700 dark:text-gray-200 group-hover:text-accent-600 dark:group-hover:text-accent-400 transition-colors line-clamp-2">
            {nextPost.data.title}
          </span>
        </a>
      ) : <div />}
    </nav>
  </article>
</BaseLayout>